<html>
  <head>
    <style>
form {
  display: flex;
  flex-direction: column;
}
    </style>
  </head>
  <body>
    <main id="app"></main>
    <script type="module">

import { app } from "https://unpkg.com/hyperapp"
import {
  main,
  h1, h2, h3,
  button,
  text,
  section,
  label,
  form,
  input,
  ul, li,
} from "https://unpkg.com/@hyperapp/html?module"

const formulae = {
  "distance-modulus": {
    name: "distance modulus",
    order: [ "d" , "M", "m", "µ" ],
    variables: {
      µ: {
        name: "distance modulus",
        symbol: "µ",
        value: 10,
        formula: ({ m, M }) => ( m - M ),
      },
      m: {
        name: "apparent magnitude",
        symbol: "m",
        value: 5,
        formula: ({ µ, M }) => ( µ + M ),
      },
      M: {
        name: "absolute magnitude",
        symbol: "M",
        value: -5,
        formula: ({ µ, m }) => ( m - µ ),
      },
      d: {
        name: "distance",
        symbol: "d",
        value: 1000,
        unit: "parsecs",
        formula: ({ µ }) => ( Math.pow(10, (µ + 5) / 5) ),
      },
    }
  },
  "small-angle": {
    name: "small angle formula",
    order: [ "D", "d", "θ" ],
    variables: {
      θ: {
        name: "angular diameter ",
        symbol: "θ",
        value: 10,
        unit: "arcseconds",
        formula: ({ d, D }) => ( 206265*d/D ),
      },
      d: {
        name: "linear diameter",
        symbol: "d",
        value: 5,
        unit: "$Length",
        formula: ({ θ, D }) => ( θ*D/206265 ),
      },
      D: {
        name: "distance",
        symbol: "D",
        value: -5,
        unit: "$Length",
        formula: ({ θ, d }) => ( d*206265/θ )
      }
    }
  },
  "parallax": {
    name: "parallax distance",
    order: [ "p", "d" ],
    variables: {
      d: {
        name: "distance",
        symbol: "d",
        value: 10,
        unit: "parsecs",
        formula: ({ p }) => ( 1/p ),
      },
      p: {
        name: "parallax",
        symbol: "p",
        value: 0.1,
        unit: "arcseconds",
        formula: ({ d }) => ( 1/d ),
      },
    }
  },
  "magnitude-luminosity": {
    name: "magnitude-luminosity relation",
    order: [ "M_B", "M_A", "L_B", "L_A" ],
    variables: {
      L_A: {
        name: "luminosity A",
        symbol: "L_A",
        value: 10,
        unit: "Watts",
        formula: ({ L_B, M_B, M_A }) => ( L_B * Math.pow(100, (M_B - M_A) / 5) ),
      },
      L_B: {
        name: "luminosity B",
        symbol: "L_B",
        value: 10,
        unit: "Watts",
        formula: ({ L_A, M_B, M_A }) => ( L_A / Math.pow(100, (M_B - M_A) / 5) ),
      },
      M_A: {
        name: "magnitude A",
        symbol: "M_A",
        value: 10,
        unit: "Watts",
        formula: ({ L_A, L_B, M_B }) => ( M_B - 2.5 * Math.log(L_A / L_B) ),
      },
      M_B: {
        name: "magnitude B",
        symbol: "M_B",
        value: 10,
        unit: "Watts",
        formula: ({ L_A, L_B, M_A }) => ( M_A + 2.5 * Math.log(L_A / L_B) ),
      },
    }
  },
}

const Update = (form_id, variable_id) => ( state, event ) => {
  const form = state.formulae[form_id]
  const variables = form.variables
  variables[variable_id].value = Number(event.target.value)
  
  // Flatten values of variables
  const values = Object.fromEntries(Object.entries(variables).map(
    ([v_id, v]) => ([v_id, v.value])
  ))
  
  // Move current variable to last in calculation order
  // The variables that have been manually inputted more recently are thus held more constant
  form.order.push(form.order.splice(form.order.indexOf(variable_id), 1)[0])
  
  // Calculate other variables in order
  for(const v_id of form.order) {
    if(v_id == variable_id) continue
    console.log(v_id)
    const v = variables[v_id]
    values[v_id] = v.formula(values)
    v.value = values[v_id]
  }
  return { ...state }
}

app({
  init: { formulae },
  view: ({ formulae }) =>
    main([
      h1(text('ASTROFORMULATRON')),
      h3(text('An astronomy calculator by Xing')),
      ul(Object.entries(formulae).map(([f_id, f]) => 
        li({id: f_id}, form([
          text(f.name),
          ul(Object.entries(f.variables).map(([v_id, v]) => 
            li({id: f_id}, label([
              text('[' + f.order.indexOf(v_id) + '] '),
              text(v.name + " " + v.symbol + " = "),
              input({ type: "number", value: v.value, oninput: Update(f_id, v_id) }),
              v.unit && text(v.unit)
            ]))
          ))
        ]))
      ))
    ])
  ,
  node: document.getElementById("app"),
})

    </script>
  </body>
</html>
